<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <title>Formulario Producto</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
</head>

<body class="bg-light">

    <div class="container mt-5">
        <h2>Registrar Nuevo Producto</h2>
        <form id="productoForm" class="needs-validation" novalidate>
            <div class="mb-3">
                <label for="codigoProducto" class="form-label">Código del Producto</label>
                <input type="text" class="form-control" id="codigoProducto" name="codigoProducto" required>
                <div class="invalid-feedback">Por favor ingrese el código del producto.</div>
            </div>

            <div class="mb-3">
                <label for="nombreProducto" class="form-label">Nombre del Producto</label>
                <input type="text" class="form-control" id="nombreProducto" name="nombreProducto" required>
                <div class="invalid-feedback">Por favor ingrese el nombre del producto.</div>
            </div>

            <div class="mb-3">
                <label for="descripcionProducto" class="form-label">Descripción</label>
                <textarea class="form-control" id="descripcionProducto" name="descripcionProducto" required></textarea>
                <div class="invalid-feedback">Por favor ingrese una descripción.</div>
            </div>

            <div class="mb-3">
                <label for="categoria" class="form-label">Categoría</label>
                <div class="input-group">
                    <select class="form-select" id="categoria" name="categoria" required>
                        <option value="">Seleccione una categoría</option>
                    </select>
                    <button id="btnNuevaCategoria" class="btn btn-primary btn-lg" data-bs-toggle="tooltip"
                        data-bs-placement="top" title="Nueva Categoría">
                        +
                    </button>
                </div>
                <div class="invalid-feedback">Por favor seleccione una categoría o cree una nueva.</div>
            </div>

            <button type="submit" class="btn btn-primary">Guardar Producto</button>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const categoriaSelect = document.getElementById('categoria');

            // Mostrar mensaje de carga
            const loadingOption = new Option('Cargando categorías...', '', true, true);
            loadingOption.disabled = true;
            categoriaSelect.add(loadingOption);

            fetch('/api/categorias')
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Error al cargar las categorías');
                    }
                    return response.json();
                })
                .then(data => {
                    // Limpiar opciones previas
                    categoriaSelect.innerHTML = '';

                    if (data.length === 0) {
                        const noDataOption = new Option('No hay categorías disponibles', '', true, true);
                        noDataOption.disabled = true;
                        categoriaSelect.add(noDataOption);
                    } else {
                        const defaultOption = new Option('Seleccione una categoría', '', true, true);
                        defaultOption.disabled = true;
                        categoriaSelect.add(defaultOption);

                        data.forEach(categoria => {
                            const option = new Option(categoria.nombreCategoria, categoria.idCategoria);
                            categoriaSelect.add(option);
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);

                    Swal.fire({
                        icon: 'error',
                        title: 'Oops...',
                        text: 'No se pudieron cargar las categorías. Intenta más tarde.',
                        confirmButtonColor: '#3085d6',
                        confirmButtonText: 'OK'
                    });

                    // También limpiar y mostrar error en el select
                    categoriaSelect.innerHTML = '';
                    const errorOption = new Option('Error cargando categorías', '', true, true);
                    errorOption.disabled = true;
                    categoriaSelect.add(errorOption);
                });
        });

        document.getElementById('btnNuevaCategoria').addEventListener('click', function () {
            Swal.fire({
                title: 'Crear Nueva Categoría',
                input: 'text',
                inputLabel: 'Nombre de la categoría',
                inputPlaceholder: 'Ej: Tecnología, Hogar, Juguetería',
                showCancelButton: true,
                confirmButtonText: 'Crear',
                cancelButtonText: 'Cancelar',
                inputValidator: (value) => {
                    if (!value) {
                        return 'Debes ingresar un nombre para la categoría';
                    }
                }
            }).then((result) => {
                if (result.isConfirmed) {
                    const nombreCategoria = result.value.trim();

                    // Paso 1: Consultar si ya existe
                    fetch(`/api/categorias/existe?nombre=${encodeURIComponent(nombreCategoria)}`)
                        .then(response => response.json())
                        .then(existe => {
                            if (existe) {
                                Swal.fire({
                                    icon: 'warning',
                                    title: 'Categoría ya existe',
                                    text: `La categoría "${nombreCategoria}" ya existe en el sistema.`,
                                    confirmButtonColor: '#f27474',
                                });
                            } else {
                                // Paso 2: Crear categoría nueva
                                fetch('/api/categorias', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ nombreCategoria: nombreCategoria })
                                })
                                    .then(response => {
                                        if (!response.ok) {
                                            throw new Error('Error al crear categoría');
                                        }
                                        return response.json();
                                    })
                                    .then(nuevaCategoria => {
                                        // Agregar nueva categoría al select
                                        const categoriaSelect = document.getElementById('categoria');
                                        const option = new Option(nuevaCategoria.nombreCategoria, nuevaCategoria.idCategoria);
                                        categoriaSelect.add(option);
                                        categoriaSelect.value = nuevaCategoria.idCategoria;

                                        Swal.fire({
                                            icon: 'success',
                                            title: 'Categoría creada',
                                            text: `La categoría "${nuevaCategoria.nombreCategoria}" ha sido creada y seleccionada.`,
                                            confirmButtonColor: '#3085d6',
                                        });
                                    })
                                    .catch(error => {
                                        console.error('Error creando categoría:', error);
                                        Swal.fire({
                                            icon: 'error',
                                            title: 'Oops...',
                                            text: 'No se pudo crear la categoría. Intenta más tarde.',
                                        });
                                    });
                            }
                        })
                        .catch(error => {
                            console.error('Error verificando categoría:', error);
                            Swal.fire({
                                icon: 'error',
                                title: 'Error de comunicación',
                                text: 'No se pudo verificar si la categoría existe. Intenta más tarde.',
                            });
                        });
                }
            });
        });


        // Enviar formulario
        document.getElementById('productoForm').addEventListener('submit', function (e) {
            e.preventDefault();

            if (!this.checkValidity()) {
                e.stopPropagation();
                this.classList.add('was-validated');
                return;
            }

            const producto = {
                codigoProducto: document.getElementById('codigoProducto').value,
                nombreProducto: document.getElementById('nombreProducto').value,
                descripcionProducto: document.getElementById('descripcionProducto').value,
                categoria: { idCategoria: document.getElementById('categoria').value }
            };

            fetch('/api/productos', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(producto)
            })
                .then(response => {
                    if (response.ok) {
                        alert('Producto creado exitosamente');
                        document.getElementById('productoForm').reset();
                        document.getElementById('productoForm').classList.remove('was-validated');
                    } else {
                        alert('Error al crear producto');
                    }
                })
                .catch(error => console.error('Error:', error));
        });

        // Activar todos los tooltips de la página
        document.addEventListener('DOMContentLoaded', function () {
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.forEach(function (tooltipTriggerEl) {
                new bootstrap.Tooltip(tooltipTriggerEl);
            });
        });
    </script>

</body>

</html>